<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cases - QA Agent Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-brand">
                    <i class="bi bi-robot"></i>
                    <span>QA Agent</span>
                </a>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <i class="bi bi-speedometer2"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/test-cases" class="nav-link active">
                        <i class="bi bi-list-check"></i>
                        <span>Test Cases</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/chat" class="nav-link">
                        <i class="bi bi-chat-dots"></i>
                        <span>Chat</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/settings" class="nav-link">
                        <i class="bi bi-gear"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-wrapper">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="bi bi-list-check"></i> Test Cases</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#testCaseModal" onclick="openCreateModal()">
                        <i class="bi bi-plus-circle"></i> New Test Case
                    </button>
                </div>
                <hr>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>URL</th>
                                        <th>Tags</th>
                                        <th>Executions</th>
                                        <th>Last Run</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="testCasesTable">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case Modal -->
    <div class="modal fade" id="testCaseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">New Test Case</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="testCaseForm">
                        <input type="hidden" id="testCaseId">
                        <div class="mb-3">
                            <label for="testCaseName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="testCaseName" required>
                        </div>
                        <div class="mb-3">
                            <label for="testCaseUrl" class="form-label">URL</label>
                            <input type="url" class="form-control" id="testCaseUrl" required>
                        </div>
                        <div class="mb-3">
                            <label for="testCasePrompt" class="form-label">Test Instructions</label>
                            <textarea class="form-control" id="testCasePrompt" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="testCaseTags" class="form-label">Tags (comma separated)</label>
                            <input type="text" class="form-control" id="testCaseTags" placeholder="login, auth, validation">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTestCase()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTestCaseId = null;
        const modal = new bootstrap.Modal(document.getElementById('testCaseModal'));

        async function loadTestCases() {
            try {
                const response = await fetch('/api/test-cases');
                const testCases = await response.json();
                
                const tbody = document.getElementById('testCasesTable');
                tbody.innerHTML = '';
                
                if (testCases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No test cases found. Create your first test case!</td></tr>';
                    return;
                }
                
                testCases.forEach(tc => {
                    const row = document.createElement('tr');
                    
                    const tags = tc.tags && tc.tags.length > 0
                        ? tc.tags.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join(' ')
                        : '-';
                    
                    const lastRun = tc.lastExecutedAt 
                        ? new Date(tc.lastExecutedAt).toLocaleString('ko-KR')
                        : 'Never';
                    
                    row.innerHTML = `
                        <td><strong>${tc.name}</strong></td>
                        <td><small>${tc.url}</small></td>
                        <td>${tags}</td>
                        <td>${tc.executionCount || 0}</td>
                        <td><small>${lastRun}</small></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="runTestCase('${tc.id}')" title="Run">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editTestCase('${tc.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTestCase('${tc.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load test cases:', error);
                document.getElementById('testCasesTable').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Failed to load test cases</td></tr>';
            }
        }

        function openCreateModal() {
            currentTestCaseId = null;
            document.getElementById('modalTitle').textContent = 'New Test Case';
            document.getElementById('testCaseForm').reset();
            document.getElementById('testCaseId').value = '';
        }

        async function editTestCase(id) {
            try {
                const response = await fetch(`/api/test-cases/${id}`);
                const tc = await response.json();
                
                currentTestCaseId = id;
                document.getElementById('modalTitle').textContent = 'Edit Test Case';
                document.getElementById('testCaseId').value = tc.id;
                document.getElementById('testCaseName').value = tc.name;
                document.getElementById('testCaseUrl').value = tc.url;
                document.getElementById('testCasePrompt').value = tc.prompt;
                document.getElementById('testCaseTags').value = tc.tags ? tc.tags.join(', ') : '';
                
                modal.show();
            } catch (error) {
                console.error('Failed to load test case:', error);
                alert('Failed to load test case');
            }
        }

        async function saveTestCase() {
            const name = document.getElementById('testCaseName').value;
            const url = document.getElementById('testCaseUrl').value;
            const prompt = document.getElementById('testCasePrompt').value;
            const tagsStr = document.getElementById('testCaseTags').value;
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
            
            const testCase = { name, url, prompt, tags };
            
            try {
                let response;
                if (currentTestCaseId) {
                    response = await fetch(`/api/test-cases/${currentTestCaseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testCase)
                    });
                } else {
                    response = await fetch('/api/test-cases', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testCase)
                    });
                }
                
                if (response.ok) {
                    modal.hide();
                    loadTestCases();
                } else {
                    alert('Failed to save test case');
                }
            } catch (error) {
                console.error('Failed to save test case:', error);
                alert('Failed to save test case');
            }
        }

        async function deleteTestCase(id) {
            if (!confirm('Are you sure you want to delete this test case?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/test-cases/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadTestCases();
                } else {
                    alert('Failed to delete test case');
                }
            } catch (error) {
                console.error('Failed to delete test case:', error);
                alert('Failed to delete test case');
            }
        }

        async function runTestCase(id) {
            if (!confirm('Run this test case? This will open a browser and execute the test.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/test-cases/${id}/run`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Test case started! Check the chat page for progress.');
                    // Optionally redirect to chat page
                    // window.location.href = '/chat';
                } else {
                    alert('Failed to run test case');
                }
            } catch (error) {
                console.error('Failed to run test case:', error);
                alert('Failed to run test case');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTestCases();
        });
    </script>
</body>
</html>
